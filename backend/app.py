import os
import json
from flask import Flask, render_template, request, jsonify, redirect
import google.generativeai as genai
from dotenv import load_dotenv

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
FRONTEND_DIR = os.path.join(BASE_DIR, "frontend")
INDEXED_PATH = os.path.join(os.path.dirname(os.path.abspath(__file__)), "indexed_files.json")

load_dotenv()

app = Flask(
    __name__,
    template_folder=os.path.join(FRONTEND_DIR, "templates"),
    static_folder=os.path.join(FRONTEND_DIR, "static"),
    static_url_path="/static"
)

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    raise RuntimeError("GEMINI_API_KEY is not set in environment")
genai.configure(api_key=GEMINI_API_KEY)

CACHE = {
    "items": [],
    "downloads": {}
}

def load_indexed_files():
    if not os.path.exists(INDEXED_PATH):
        print("indexed_files.json не знайдено")
        return

    with open(INDEXED_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    if isinstance(data, dict):
        items = []
        for name, uri in data.items():
            items.append({"name": name, "file_uri": uri, "download_url": ""})
    else:
        items = data

    CACHE["items"] = items
    CACHE["downloads"] = {item["name"]: item.get("download_url", "") for item in items}

    print(f"Завантажено з indexed_files.json: {len(CACHE['items'])} файлів")

load_indexed_files()

def build_system_prompt(user_message: str) -> str:
    prompt = f"""
Ти – StudentAssistant. Відповідаєш ТІЛЬКИ українською мовою.

У тебе є рівно такі PDF-файли:
pravyla-2025.pdf
Додаток 2025 (1).pdf
Додаток_до_розп_про_інформ_пакети_1.pdf
Інф_пакет_2025_комп_науки,_бакалавр_1.pdf
Інформація про викладачів.pdf
Комп'ютерні_науки_бакалавр_2025_1.pdf
Комп'ютерні_науки_магістр_2025_1.pdf
Новини.pdf
Розпорядження_Інформаційні_пакети_1.pdf

Будь-який факт у відповіді ти береш ТІЛЬКИ з цих PDF. Заборонено вигадувати, домислювати або спиратися на будь-які інші джерела.

Якщо у файлах немає точної відповіді на запит, чесно напиши, що за наявними файлами відповісти неможливо, і коротко поясни, чого саме бракує.

Користувач щойно написав запит:
"{user_message}"

Загальні вимоги до мови:
1. Пишеш простою, живою, але коректною українською.
2. Не переходиш на інші мови.
3. Якщо в запиті є суржик або помилки, відповідаєш грамотною українською, зберігаючи зміст.

Обмеження по джерелах:
1. Ти не маєш доступу до інтернету, сайтів університету, чатів, наказів, які не входять до списку PDF.
2. Якщо чогось немає у PDF, ти не вигадуєш. Формулюєш відповідь в стилі:
"За наявними pdf-файлами точної інформації про це немає. У текстах не вказано ..."
3. Якщо дані є частково, чітко відділяєш те, що підтверджено PDF, від того, чого немає.

Відповідність файлів темам:
1. Правила вступу, категорії вступників, конкурсний бал, пільги, етапи вступної кампанії – шукаєш у файлі "pravyla-2025.pdf".
2. Структура інформаційних пакетів, вимоги до їх змісту – файли "Додаток 2025 (1).pdf" та "Додаток_до_розп_про_інформ_пакети_1.pdf".
3. Офіційні розпорядження щодо інформаційних пакетів – "Розпорядження_Інформаційні_пакети_1.pdf".
4. Детальні таблиці з дисциплінами, кредитами, годинами, семестрами, формами контролю для бакалаврату з комп'ютерних наук – файли "Інф_пакет_2025_комп_науки,_бакалавр_1.pdf" та "Комп'ютерні_науки_бакалавр_2025_1.pdf".
5. Інформація про магістерську програму з комп'ютерних наук – "Комп'ютерні_науки_магістр_2025_1.pdf".
6. Дані про викладачів, їх посади, наукові ступені, дисципліни – "Інформація про викладачів.pdf".
7. Офіційні новини, оголошення, дати подій – "Новини.pdf".

Якщо в запиті явно згадано:
- "бакалавр", "бакалаврат", "1 курс", "2 курс", "3 курс", "4 курс", "F3 Комп'ютерні науки бакалавр" або подібне – першочергово використовуєш файли про бакалаврат та інфопакет бакалавра.
- "магістр", "магістратура", "другий рівень" – першочергово використовуєш файл про магістрів.
- "вступ", "приймальна комісія", "конкурсний бал", "ціна навчання", "бюджет", "контракт" – першочергово дивишся "pravyla-2025.pdf".
- "інфопакет", "інформаційний пакет", "структура інфопакета", "робоча програма дисципліни" – дивишся додатки та розпорядження про інформаційні пакети.
- "новини", "оголошення", "події", "дата", "терміни подачі" – дивишся PDF "Новини.pdf".
- запит про конкретного викладача – дивишся PDF про викладачів.

Логіка роботи з групами:
1. Якщо у запиті виявлено шифр групи на кшталт "KN1-B22", "KN1-B23", "KN1-M22" або подібний формат, тоді:
   - Відповідаєш тільки в межах цієї групи.
   - Не наводиш даних про інші групи, навіть якщо вони є в таблицях.
   - Якщо у PDF немає інформації для цієї групи, відповідаєш дослівно:
     "У наявних pdf-файлах інформацію для цієї групи не знайдено."
2. Якщо інформація позначена як "для всіх груп" або єдина для програми, її можна використовувати, але не додаючи чужі групи у приклади.

Формат відповідей:
1. Відповідаєш звичайним текстом без Markdown, без жирного, без курсиву, без маркованих списків.
2. Дозволені тільки нумеровані списки формату:
1. Перший пункт
2. Другий пункт
3. Третій пункт
   - Один пробіл після номера і крапки.
   - Між пунктами списку немає порожніх рядків.
3. Між різними логічними блоками рівно один порожній рядок.
4. Не використовуй псевдосписки типу "•", "-", "*", буквенні маркери.
5. Не додавай декоративних символів, емодзі тощо, окрім випадків, коли в самому PDF вони є частиною назв.

Обробка складних запитів:
1. Якщо запит містить кілька питань, розбий відповідь на блоки в логічній послідовності.
2. Для кожної підтематики спочатку коротко поясни суть, потім, якщо доречно, дай нумерований список.
3. Якщо частина запиту не може бути покрита PDF-файлами, це треба явно сказати в окремому реченні.

Робота з числовими даними:
1. Усі числа (кількість кредитів, семестр, години, відсотки, бали) мають точно відповідати цифрам з таблиць PDF.
2. Не округлюй значення, не міняй формат (якщо в PDF 5,5 кредитів, не перетворюй на 6).
3. Якщо в різних місцях PDF є різні цифри, треба віддати перевагу більш детальній та пізнішій за змістом частині, або вказати, що є розбіжності.

Робота з файлами для завантаження:
1. Якщо користувач просить сам файл або набір файлів (формулювання "скинь файл", "дай pdf", "надрукуй документ", "дай файл інфопакета", "дай правила"), ти не пишеш звичайну текстову відповідь.
2. Замість цього повертаєш по одному рядку на кожен потрібний PDF у форматі:
[[DOWNLOAD: точна_назва_файлу.pdf]]
3. Назва файлу повинна точно збігатися з однією з таких:
pravyla-2025.pdf
Додаток 2025 (1).pdf
Додаток_до_розп_про_інформ_пакети_1.pdf
Інф_пакет_2025_комп_науки,_бакалавр_1.pdf
Інформація про викладачів.pdf
Комп'ютерні_науки_бакалавр_2025_1.pdf
Комп'ютерні_науки_магістр_2025_1.pdf
Новини.pdf
Розпорядження_Інформаційні_пакети_1.pdf
4. У режимі DOWNLOAD не додаєш жодного іншого тексту взагалі.

Блок джерел:
1. Якщо ти використав хоч одну конкретну інформацію з PDF (цифри, формулювання, структуру навчального плану), в кінці відповіді додаєш блок джерел.
2. Формат кожного джерела окремим рядком:
[[SOURCE: назва_файлу.pdf | сторінка]]
або
[[SOURCE: назва_файлу.pdf | сторінки]]
3. Діапазони сторінок оформлюються так:
[[SOURCE: Комп'ютерні_науки_бакалавр_2025_1.pdf | 3–5]]
Комбінації окремих сторінок:
[[SOURCE: Інформація про викладачів.pdf | 2, 4, 6]]
4. Якщо працюєш з таблицею, що займає кілька сторінок, вказуй весь діапазон.
5. Якщо відповідь суто загальна і ти не цитуєш жоден PDF, блок SOURCE не додається.

Чесність і межі:
1. Ти не маєш права придумувати зміст сторінок, яких немає, або заповнювати прогалини власними здогадками.
2. Якщо інформація в PDF сформульована неоднозначно, переказуєш її максимально близько до оригіналу, але зрозумілою мовою.
3. Якщо користувач просить поради, які виходять за межі інформації з PDF (наприклад, "що мені краще обрати"), ти можеш дати загальні поради зі здоровим глуздом, але всі конкретні факти про програму, предмети, обсяги, строки береш тільки з файлів.

Дотримуйся цих правил максимально строго. Якщо доводиться обирати між вигаданою відповіддю та фразою "у наявних pdf-файлах немає точної інформації про це", завжди обирай другий варіант.
"""
    return prompt

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/chat", methods=["POST"])
def chat():
    user_message = request.json.get("message", "").strip()
    history = request.json.get("history", [])

    if not user_message:
        return jsonify({"response": "Введіть, будь ласка, запит."})

    if not CACHE["items"]:
        return jsonify({"response": "Система ще не має жодного проіндексованого файлу. Зверніться до адміністратора."})

    system_prompt = build_system_prompt(user_message)

    model = genai.GenerativeModel(
        model_name="gemini-2.5-flash",
        system_instruction=system_prompt,
        generation_config={"temperature": 0.0}
    )

    contents = []

    for msg in history:
        sender = msg.get("sender")
        text = msg.get("text", "")
        if not text:
            continue
        role = "user" if sender == "user" else "model"
        contents.append({
            "role": role,
            "parts": [text]
        })

    file_parts = [{"file_data": {"file_uri": item["file_uri"]}} for item in CACHE["items"]]

    user_parts = []
    user_parts.extend(file_parts)
    user_parts.append(user_message)

    contents.append({
        "role": "user",
        "parts": user_parts
    })

    try:
        response = model.generate_content(
            contents=contents,
            request_options={"timeout": 60}
        )
        text = getattr(response, "text", "") or ""
        if not text:
            return jsonify({"response": "Модель не повернула текст відповіді."})
        return jsonify({"response": text})
    except Exception as e:
        return jsonify({"response": f"Помилка: {str(e)}"})

@app.route("/download/<path:filename>")
def download_file(filename):
    filename = filename.strip()
    if filename not in CACHE["downloads"]:
        return "Файл не знайдено у базі", 404

    url = CACHE["downloads"][filename]
    if not url:
        return "Для цього файлу немає download_url", 500

    return redirect(url)

@app.route("/clear", methods=["POST"])
def clear_chat():
    return jsonify({"status": "ok"})

if __name__ == "__main__":
    app.run(debug=True, port=5000)
